---
import { t, type Locale } from '../lib/i18n';
import cookieConsentClientUrl from '../lib/cookieConsentClient.ts?url';

const locale: Locale = Astro.props.locale ?? 'it';
const policyHref = locale === 'en' ? '/en/privacy' : '/privacy';
---

<div class="gdpr-consent" data-gdpr-consent-root data-locale={locale}>
  <!-- Banner (hidden until client decides it must be shown) -->
  <div class="gdpr-banner gdpr-hidden" role="dialog" aria-modal="true" aria-labelledby="gdpr-banner-title">
    <div class="gdpr-banner__inner">
      <p id="gdpr-banner-title" class="gdpr-banner__text">
        {t('bannerMessage', locale)}
        <a class="gdpr-link" href={policyHref}>
          {t('policyLink', locale)}
        </a>
      </p>

      <div class="gdpr-banner__actions">
        <button type="button" class="ds-btn" data-variant="primary" data-size="sm" data-gdpr-action="accept-all">
          {t('acceptAll', locale)}
        </button>
        <button type="button" class="ds-btn" data-variant="ghost" data-size="sm" data-gdpr-action="reject-all">
          {t('rejectAll', locale)}
        </button>
        <button type="button" class="ds-btn" data-variant="ghost" data-size="sm" data-gdpr-action="open-preferences">
          {t('managePreferences', locale)}
        </button>
      </div>
    </div>
  </div>

  <!-- Preferences modal (hidden by default) -->
  <div class="gdpr-modal gdpr-hidden" role="dialog" aria-modal="true" aria-labelledby="gdpr-modal-title">
    <div class="gdpr-modal__backdrop" data-gdpr-action="close"></div>

    <div class="gdpr-modal__panel" role="document" tabindex="-1">
      <div class="gdpr-modal__header">
        <h2 id="gdpr-modal-title" class="gdpr-modal__title">{t('preferencesTitle', locale)}</h2>
        <button type="button" class="ds-btn" data-variant="ghost" data-size="sm" data-gdpr-action="close" aria-label={t('closeButton', locale)}>
          {t('closeButton', locale)}
        </button>
      </div>

      <form class="gdpr-form" data-gdpr-form>
        <div class="gdpr-row">
          <div class="gdpr-row__label">
            <strong>{t('essentialAlwaysOn', locale)}</strong>
          </div>
          <div class="gdpr-row__control">
            <span class="gdpr-chip" aria-hidden="true">On</span>
          </div>
        </div>

        <label class="gdpr-row">
          <span class="gdpr-row__label">
            <strong>{t('analyticsLabel', locale)}</strong>
          </span>
          <span class="gdpr-row__control">
            <input type="checkbox" name="analytics" class="gdpr-toggle" />
          </span>
        </label>

        <label class="gdpr-row">
          <span class="gdpr-row__label">
            <strong>{t('marketingLabel', locale)}</strong>
          </span>
          <span class="gdpr-row__control">
            <input type="checkbox" name="marketing" class="gdpr-toggle" />
          </span>
        </label>

        <div class="gdpr-form__actions">
          <button type="submit" class="ds-btn" data-variant="primary" data-size="sm">
            {t('saveButton', locale)}
          </button>
          <button type="button" class="ds-btn" data-variant="ghost" data-size="sm" data-gdpr-action="close">
            {t('closeButton', locale)}
          </button>
          <a class="gdpr-link gdpr-link--inline" href={policyHref}>
            {t('policyLink', locale)}
          </a>
        </div>
      </form>
    </div>
  </div>
</div>

<script type="module" src={cookieConsentClientUrl}></script>

<style>
  .gdpr-hidden {
    display: none;
  }

  /* Banner */
  .gdpr-banner {
    position: fixed;
    inset-inline: 0;
    bottom: 0;
    z-index: 2000;
    padding: var(--ds-space-4);
    background: color-mix(in srgb, var(--ds-color-surface) 92%, transparent);
    border-top: var(--ds-border-1) solid var(--ds-color-border);
    backdrop-filter: blur(10px);
  }

  .gdpr-banner__inner {
    max-width: var(--ds-container-max);
    margin: 0 auto;
    padding-inline: var(--ds-container-pad);
    display: flex;
    gap: var(--ds-space-4);
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
  }

  .gdpr-banner__text {
    margin: 0;
    color: var(--ds-color-text);
    font-size: var(--ds-text-sm);
    line-height: var(--ds-leading-relaxed);
    max-width: 70ch;
  }

  .gdpr-link {
    margin-inline-start: var(--ds-space-2);
    color: var(--ds-color-accent);
    text-decoration: none;
    font-weight: 600;
  }

  .gdpr-link:hover {
    text-decoration: underline;
  }

  .gdpr-link--inline {
    margin-inline-start: 0;
    align-self: center;
  }

  .gdpr-banner__actions {
    display: inline-flex;
    gap: var(--ds-space-2);
    flex-wrap: wrap;
  }

  /* Modal */
  .gdpr-modal {
    position: fixed;
    inset: 0;
    z-index: 2100;
    display: grid;
    place-items: center;
    padding: var(--ds-space-4);
  }

  .gdpr-modal__backdrop {
    position: absolute;
    inset: 0;
    background: color-mix(in srgb, black 50%, transparent);
  }

  .gdpr-modal__panel {
    position: relative;
    width: min(42rem, 100%);
    background: var(--ds-color-surface);
    border: var(--ds-border-1) solid var(--ds-color-border);
    border-radius: var(--ds-radius-3);
    box-shadow: var(--ds-shadow-2);
    padding: var(--ds-space-6);
    outline: none;
  }

  .gdpr-modal__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--ds-space-3);
    margin-bottom: var(--ds-space-4);
  }

  .gdpr-modal__title {
    margin: 0;
    font-size: var(--ds-text-lg);
    color: var(--ds-color-text);
    letter-spacing: var(--ds-tracking-tight);
  }

  .gdpr-form {
    display: grid;
    gap: var(--ds-space-3);
  }

  .gdpr-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--ds-space-4);
    padding: var(--ds-space-3);
    border: var(--ds-border-1) solid var(--ds-color-border);
    border-radius: var(--ds-radius-2);
    background: var(--ds-color-surface-2);
    color: var(--ds-color-text);
  }

  .gdpr-row__label {
    display: grid;
    gap: var(--ds-space-1);
  }

  .gdpr-row__control {
    display: inline-flex;
    align-items: center;
    gap: var(--ds-space-2);
  }

  .gdpr-toggle {
    width: 1.1rem;
    height: 1.1rem;
    accent-color: var(--ds-color-accent);
  }

  .gdpr-chip {
    font-size: var(--ds-text-xs);
    font-weight: 700;
    padding: 0.15rem 0.5rem;
    border-radius: var(--ds-radius-round);
    border: var(--ds-border-1) solid color-mix(in srgb, var(--ds-color-success) 30%, var(--ds-color-border));
    color: var(--ds-color-success);
    background: color-mix(in srgb, var(--ds-color-success) 10%, var(--ds-color-surface));
  }

  .gdpr-form__actions {
    display: flex;
    justify-content: flex-end;
    gap: var(--ds-space-2);
    margin-top: var(--ds-space-2);
    flex-wrap: wrap;
  }

  /* Prevent background scroll when modal open */
  :global(html.gdpr-modal-open),
  :global(html.gdpr-modal-open body) {
    overflow: hidden;
  }

  @media (max-width: 40rem) {
    .gdpr-modal__panel {
      padding: var(--ds-space-4);
    }
    .gdpr-banner__inner {
      align-items: stretch;
    }
    .gdpr-banner__actions {
      width: 100%;
      justify-content: flex-start;
    }
  }
</style>

