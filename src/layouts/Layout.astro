---
export interface Props {
  title: string;
  description?: string;
  heroImage?: string;
  canonical?: string;
  lang?: 'it' | 'en';
  structuredData?: unknown | unknown[];
}

const {
  title,
  description,
  heroImage,
  canonical = Astro.url.pathname,
  lang = 'it',
  structuredData,
} = Astro.props;

const siteName = 'Devisia';
const homeTitleSuffix =
  lang === 'en'
    ? 'Technology partner for SaaS & custom software'
    : 'Partner tecnologico per SaaS e software su misura';
const fullTitle = title === 'Home' ? `${siteName} â€” ${homeTitleSuffix}` : `${title} | ${siteName}`;
const canonicalURL = new URL(canonical, Astro.site);

const defaultDescription =
  lang === 'en'
    ? 'Devisia - Your trusted technology partner for digital innovation and business transformation.'
    : 'Devisia - Il tuo partner tecnologico per innovazione digitale e trasformazione del business.';

const metaDescription = description ?? defaultDescription;

const localePrefix = lang === 'en' ? '/en' : '';
const href = (path: string) => (localePrefix ? `${localePrefix}${path}` : path);
const homeHref = localePrefix || '/';

const pathName = canonicalURL.pathname;
const itPath = lang === 'en' ? pathName.replace(/^\/en(?=\/|$)/, '') || '/' : pathName;
const enPath = itPath === '/' ? '/en/' : `/en${itPath}`;
const languageSwitchHref = lang === 'en' ? itPath : enPath;
const languageSwitchLabel = lang === 'en' ? 'IT' : 'EN';
const languageSwitchAria = lang === 'en' ? 'Switch to Italian' : 'Passa a inglese';

const normalizePath = (p: string) => {
  const withoutTrailing = p.length > 1 ? p.replace(/\/+$/, '') : p;
  return withoutTrailing || '/';
};

const currentPath = normalizePath(pathName);

const isActive = (targetHref: string, mode: 'exact' | 'section' = 'exact') => {
  const target = normalizePath(targetHref);
  if (mode === 'exact') return currentPath === target;
  return currentPath === target || currentPath.startsWith(`${target}/`);
};

import '../styles/tokens.css';
import '../styles/base.css';
import '../styles/components.css';
import '../styles/utilities.css';

import CookieConsent from '../components/CookieConsent.astro';
import { t } from '../lib/i18n';

const themeToggleLabel = lang === 'en' ? 'Toggle theme' : 'Cambia tema';

import {
  organizationJsonLd,
  websiteJsonLd,
  webPageJsonLd,
  type JsonLd,
} from '../lib/seo/structuredData';

const site = Astro.site ?? new URL('https://devisia.pro');
const pageUrl = canonicalURL.toString();

const baseStructuredData: JsonLd[] = [
  organizationJsonLd(site),
  websiteJsonLd(site, lang),
  webPageJsonLd({
    site,
    lang,
    url: pageUrl,
    name: fullTitle,
    description: metaDescription,
  }),
];

const extraStructuredData: JsonLd[] = Array.isArray(structuredData)
  ? (structuredData as JsonLd[])
  : structuredData
    ? ([structuredData] as JsonLd[])
    : [];
---

<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />

    <!-- Primary Meta Tags -->
    <title>{fullTitle}</title>
    <meta name="title" content={fullTitle} />
    <meta name="description" content={metaDescription} />
    <link rel="canonical" href={canonicalURL} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:title" content={fullTitle} />
    <meta property="og:description" content={metaDescription} />
    <meta property="og:site_name" content={siteName} />
    {heroImage && <meta property="og:image" content={new URL(heroImage, Astro.site)} />}

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={canonicalURL} />
    <meta property="twitter:title" content={fullTitle} />
    <meta property="twitter:description" content={metaDescription} />
    {heroImage && <meta property="twitter:image" content={new URL(heroImage, Astro.site)} />}

    <!-- i18n alternates -->
    <link rel="alternate" hrefLang="it" href={new URL(itPath, site)} />
    <link rel="alternate" hrefLang="en" href={new URL(enPath, site)} />
    <link rel="alternate" hrefLang="x-default" href={new URL(itPath, site)} />

    {
      (baseStructuredData.length || extraStructuredData.length) && (
        <>
          {[...baseStructuredData, ...extraStructuredData].map((item) => (
            <script type="application/ld+json" set:html={JSON.stringify(item)} />
          ))}
        </>
      )
    }

    <!-- Fonts (Optional: Add Google Fonts or other font services) -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />

    <script is:inline>
      // Apply saved theme early to avoid flash
      (() => {
        try {
          const key = 'ds-theme';
          const saved = localStorage.getItem(key);
          if (saved === 'dark' || saved === 'light') {
            document.documentElement.setAttribute('data-theme', saved);
          }
        } catch {
          /* noop */
        }
      })();
    </script>
  </head>

  <body>
    <a class="skip-link" href="#main">Skip to content</a>
    <!-- Header / Navigation -->
    <header class="site-header">
      <nav class="nav-container ds-container" aria-label="Primary">
        <div class="nav-brand">
          <a href={homeHref} class="logo" aria-label="DEVISIA">
            <img class="logo-img logo-img--light" src="/images/logo.svg" alt="DEVISIA" />
            <img class="logo-img logo-img--dark" src="/images/logo-inverted.svg" alt="DEVISIA" />
          </a>
        </div>

        <button
          type="button"
          class="ds-btn nav-toggle"
          data-variant="ghost"
          data-size="sm"
          aria-label={lang === 'en' ? 'Open menu' : 'Apri menu'}
          aria-controls="primary-nav"
          aria-expanded="false"
          data-nav-toggle
        >
          <svg
            class="nav-toggle__icon nav-toggle__icon--open"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            aria-hidden="true"
          >
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
          </svg>
          <svg
            class="nav-toggle__icon nav-toggle__icon--close"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            aria-hidden="true"
          >
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
          <span class="nav-toggle__label">{lang === 'en' ? 'Menu' : 'Menu'}</span>
        </button>

        <ul id="primary-nav" class="nav-menu" data-nav-menu>
          <li>
            <a href={homeHref} class="nav-link" aria-current={isActive(homeHref, 'exact') ? 'page' : undefined}>
              Home
            </a>
          </li>
          <li>
            <a href={href('/about')} class="nav-link" aria-current={isActive(href('/about'), 'section') ? 'page' : undefined}>
              About
            </a>
          </li>
          <li>
            <a href={href('/services')} class="nav-link" aria-current={isActive(href('/services'), 'section') ? 'page' : undefined}>
              Services
            </a>
          </li>
          <li>
            <a href={href('/projects')} class="nav-link" aria-current={isActive(href('/projects'), 'section') ? 'page' : undefined}>
              Projects
            </a>
          </li>
          <li>
            <a href={href('/blog')} class="nav-link" aria-current={isActive(href('/blog'), 'section') ? 'page' : undefined}>
              Blog
            </a>
          </li>
          <li>
            <a href={href('/contact')} class="nav-link nav-link-cta" aria-current={isActive(href('/contact'), 'section') ? 'page' : undefined}>
              Contact
            </a>
          </li>
          <li>
            <a
              href={languageSwitchHref}
              class="nav-link"
              aria-label={languageSwitchAria}
              title={languageSwitchAria}
            >
              {languageSwitchLabel}
            </a>
          </li>
          <li>
            <button
              type="button"
              class="ds-btn theme-toggle"
              data-variant="ghost"
              data-size="sm"
              data-theme-toggle
              aria-label={themeToggleLabel}
              title={themeToggleLabel}
            >
              <svg
                class="theme-icon theme-icon--light"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                aria-hidden="true"
              >
                <circle cx="12" cy="12" r="5"></circle>
                <line x1="12" y1="1" x2="12" y2="3"></line>
                <line x1="12" y1="21" x2="12" y2="23"></line>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                <line x1="1" y1="12" x2="3" y2="12"></line>
                <line x1="21" y1="12" x2="23" y2="12"></line>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
              </svg>
              <svg
                class="theme-icon theme-icon--dark"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                aria-hidden="true"
              >
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
              </svg>
            </button>
          </li>
        </ul>
      </nav>
    </header>

    <!-- Main Content -->
    <main id="main" class="main-content ds-container">
      <slot />
    </main>

    <!-- Footer -->
    <footer class="site-footer">
      <div class="footer-container ds-container">
        <div class="footer-content">
          <div class="footer-section">
            <h3>Devisia</h3>
            <p>
              Your trusted technology partner for digital innovation and business transformation.
            </p>
          </div>

          <div class="footer-section">
            <h4>Quick Links</h4>
            <ul class="footer-links">
              <li><a href={homeHref}>Home</a></li>
              <li><a href={href('/about')}>About</a></li>
              <li><a href={href('/services')}>Services</a></li>
              <li><a href={href('/projects')}>Projects</a></li>
              <li><a href={href('/blog')}>Blog</a></li>
              <li><a href={href('/contact')}>Contact</a></li>
            </ul>
          </div>

          <div class="footer-section">
            <h4>Connect</h4>
            <ul class="footer-links">
              <li><a href="mailto:info@devisia.pro">info@devisia.pro</a></li>
              <li>
                <a
                  href="https://github.com/stefanochermazts"
                  target="_blank"
                  rel="noopener noreferrer">GitHub</a>
              </li>
              <li>
                <a href="https://linkedin.com" target="_blank" rel="noopener noreferrer"
                  >LinkedIn</a>
              </li>
            </ul>
          </div>
        </div>

        <div class="footer-bottom">
          <p>&copy; {new Date().getFullYear()} Devisia. All rights reserved.</p>
          <button
            type="button"
            class="ds-btn"
            data-variant="ghost"
            data-size="sm"
            data-open-cookie-preferences
            aria-label={t('managePreferences', lang)}
            title={t('managePreferences', lang)}
          >
            {t('managePreferences', lang)}
          </button>
          <a class="ds-btn" data-variant="ghost" data-size="sm" href={href('/privacy')}>
            {t('policyLink', lang)}
          </a>
        </div>
      </div>
    </footer>

    <CookieConsent locale={lang} />

    <!-- GDPR consent: conditional third-party loader
         Disabled for now because the previous inline env injection caused a runtime SyntaxError in browsers.
         We'll re-enable via a bundled client module in a follow-up. -->

    <script is:inline>
      // Open GDPR cookie preferences from footer
      (() => {
        const btn = document.querySelector('[data-open-cookie-preferences]');
        if (!btn) return;
        btn.addEventListener('click', () => {
          window.dispatchEvent(new CustomEvent('open-gdpr-preferences'));
        });
      })();
    </script>

    <script is:inline>
      // Theme toggle (data-theme on <html> + localStorage)
      (() => {
        const key = 'ds-theme';
        const root = document.documentElement;
        const btn = document.querySelector('[data-theme-toggle]');
        if (!btn) return;

        const get = () => root.getAttribute('data-theme');
        const set = (t) => {
          if (!t) root.removeAttribute('data-theme');
          else root.setAttribute('data-theme', t);
        };

        // If user hasn't picked a theme yet, we keep default behavior (tokens.css uses prefers-color-scheme).
        // Button toggles explicit light/dark.
        btn.addEventListener('click', () => {
          const current = get();
          const next = current === 'dark' ? 'light' : 'dark';
          set(next);
          try {
            localStorage.setItem(key, next);
          } catch {
            /* noop */
          }
        });
      })();
    </script>

    <script is:inline>
      // Mobile nav toggle (collapsible hamburger menu)
      (() => {
        const btn = document.querySelector('[data-nav-toggle]');
        const menu = document.querySelector('[data-nav-menu]');
        if (!btn || !menu) return;

        const setOpen = (open) => {
          btn.setAttribute('aria-expanded', String(open));
          btn.setAttribute('aria-label', open ? (document.documentElement.lang === 'en' ? 'Close menu' : 'Chiudi menu') : (document.documentElement.lang === 'en' ? 'Open menu' : 'Apri menu'));
          menu.toggleAttribute('data-open', open);
        };

        // Start closed on load
        setOpen(false);

        btn.addEventListener('click', () => {
          const open = btn.getAttribute('aria-expanded') === 'true';
          setOpen(!open);
        });

        // Close menu when a link is clicked (mobile UX)
        menu.addEventListener('click', (e) => {
          const target = e.target;
          if (target && target.tagName === 'A') setOpen(false);
        });

        // Close on Escape
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') setOpen(false);
        });
      })();
    </script>
  </body>
</html>
